# Angular Testing Reference

Detailed testing patterns for Angular 21+ with Vitest.

## Vitest Configuration

```typescript
// vitest.config.ts (generated by Angular CLI)
import { defineConfig } from 'vitest/config';
import angular from '@analogjs/vite-plugin-angular';

export default defineConfig({
  plugins: [angular()],
  test: {
    globals: true,
    environment: 'jsdom',
    include: ['src/**/*.spec.ts'],
    setupFiles: ['src/test-setup.ts']
  }
});
```

## TestBed Setup

```typescript
// test-setup.ts
import '@angular/compiler';
import { TestBed } from '@angular/core/testing';
import { BrowserTestingModule } from '@angular/platform-browser/testing';

TestBed.initTestEnvironment(
  BrowserTestingModule,
  { teardown: { destroyAfterEach: true } }
);
```

## Signal Testing Patterns

### Testing Computed Signals

```typescript
it('should derive computed values correctly', () => {
  const component = TestBed.createComponent(PriceComponent).componentInstance;

  component.price.set(100);
  component.quantity.set(3);
  TestBed.flushEffects();

  // computed(() => this.price() * this.quantity())
  expect(component.total()).toBe(300);
});
```

### Testing Effects

```typescript
it('should trigger effect on signal change', () => {
  const consoleSpy = vi.spyOn(console, 'log');
  const fixture = TestBed.createComponent(LoggerComponent);

  fixture.componentInstance.message.set('Hello');
  TestBed.flushEffects();

  expect(consoleSpy).toHaveBeenCalledWith('Message changed: Hello');
});
```

### Testing Input Signals

```typescript
it('should accept input signal values', () => {
  const fixture = TestBed.createComponent(UserCardComponent);

  // Set input signal
  fixture.componentRef.setInput('user', { name: 'Alice', email: 'a@b.com' });
  fixture.detectChanges();

  expect(fixture.nativeElement.textContent).toContain('Alice');
});
```

### Testing Output Signals

```typescript
it('should emit output signal', () => {
  const fixture = TestBed.createComponent(ButtonComponent);
  const emittedValues: string[] = [];

  // Subscribe to output
  fixture.componentInstance.clicked.subscribe(v => emittedValues.push(v));

  // Trigger output
  fixture.componentInstance.onClick();

  expect(emittedValues).toEqual(['clicked']);
});
```

## Service Testing

```typescript
describe('AuthService', () => {
  let service: AuthService;
  let httpMock: HttpTestingController;

  beforeEach(() => {
    TestBed.configureTestingModule({
      imports: [HttpClientTestingModule],
      providers: [AuthService]
    });

    service = TestBed.inject(AuthService);
    httpMock = TestBed.inject(HttpTestingController);
  });

  afterEach(() => {
    httpMock.verify();
  });

  it('should login and store token', async () => {
    const loginPromise = service.login('user@test.com', 'password');

    const req = httpMock.expectOne('/api/auth/login');
    expect(req.request.method).toBe('POST');
    req.flush({ token: 'abc123', user: { id: '1' } });

    await loginPromise;

    expect(service.isAuthenticated()).toBe(true);
    expect(service.getToken()).toBe('abc123');
  });
});
```

## HTTP Testing

```typescript
import { HttpClientTestingModule, HttpTestingController } from '@angular/common/http/testing';

it('should handle HTTP errors', async () => {
  const errorPromise = service.fetchData();

  const req = httpMock.expectOne('/api/data');
  req.flush('Error', { status: 500, statusText: 'Server Error' });

  await expect(errorPromise).rejects.toThrow();
});
```

## Mocking Strategies

### Mock Service

```typescript
const mockAuthService = {
  isAuthenticated: vi.fn().mockReturnValue(true),
  getUser: vi.fn().mockReturnValue({ name: 'Test User' })
};

TestBed.configureTestingModule({
  providers: [
    { provide: AuthService, useValue: mockAuthService }
  ]
});
```

### Mock Signal

```typescript
import { signal } from '@angular/core';

const mockUserSignal = signal({ name: 'Mock User' });

TestBed.configureTestingModule({
  providers: [
    { provide: USER_SIGNAL, useValue: mockUserSignal }
  ]
});
```

## Playwright E2E Setup

```typescript
// playwright.config.ts
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  baseURL: 'http://localhost:4200',
  use: {
    trace: 'on-first-retry',
    screenshot: 'only-on-failure'
  },
  webServer: {
    command: 'ng serve',
    url: 'http://localhost:4200',
    reuseExistingServer: !process.env.CI
  }
});
```

## E2E Test Example

```typescript
import { test, expect } from '@playwright/test';

test('user can login', async ({ page }) => {
  await page.goto('/login');

  await page.fill('[data-testid="email"]', 'user@test.com');
  await page.fill('[data-testid="password"]', 'password');
  await page.click('[data-testid="submit"]');

  await expect(page).toHaveURL('/dashboard');
  await expect(page.locator('[data-testid="welcome"]')).toContainText('Welcome');
});
```

## Coverage Configuration

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html', 'lcov'],
      include: ['src/**/*.ts'],
      exclude: ['src/**/*.spec.ts', 'src/main.ts'],
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 80,
        statements: 80
      }
    }
  }
});
```
